<!DOCTYPE html>
<html>

<head>
    <title>sentinelGuard</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="./img/favicon.png">
    <link rel="apple-touch-icon" href="./img/apple-touch-icon.png">

    <link href="./libraries/css/tailwind.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<style>
    [v-cloak] {
        display: none;
    }
</style>

<body class="bg-black">
    <div id="app">
        <div v-cloak class="container mx-auto max-w-3xl">
            <div v-if="authenticated === true">
                <span v-if="requiresPassword" class="text-sm text-gray-400 mb-10 mr-2 mt-3 cursor-pointer hover:underline float-right" @click="logout">LOGOUT</span>

                <h1 class="text-4xl font-medium mt-10 mb-2">
                    <img src="./img/logo.png" width="32" class="inline align-middle" />
                </h1>

                <h2 class="text-sm text-gray-400 mb-10"></h2>

                <div class="shadow-md rounded-lg overflow-hidden" style="background: #151515;">
                    <div class="flex flex-row flex-auto items-center p-3 px-5">
                        <div class="flex-grow">
                            <p class="text-2xl font-medium text-red-500">CLIENTS</p>
                        </div>
                        <div class="flex-shrink-0">
                            <button @click="clientCreate = true; clientCreateName = '';" class="hover:bg-red-900 bg-black text-white py-2 px-4 rounded inline-flex items-center transition">
                                <i class="fa-solid fa-square-plus mr-4"></i><span class="text-sm">ADD CLIENT</span>
                            </button>
                        </div>
                    </div>

                    <div>
                        <!-- Client -->
                        <div v-if="clients && clients.length > 0" v-for="client in clients" :key="client.id" class="relative overflow-hidden">

                            <!-- Chart -->
                            <div class="absolute z-0 bottom-0 left-0 right-0" style="width: 100%; height: 20%;">
                                <!-- Bar -->
                                <div v-for="(_, index) in client.transferTxHistory" :style="{
                    display: 'inline-flex',
                    alignItems: 'flex-end',
                    width: '2%', // 1/100th of client.transferTxHistory.length
                    height: '100%',
                    padding: '0 3px',
                    boxSizing: 'border-box',
                    fontSize: 0,
                  }">

                                    <!-- TX -->
                                    <div :style="{
                    minHeight: '0px',
                    minWidth: '2px',
                    maxWidth: '4px',
                    width: '50%',
                    marginRight: '1px',
                    height: Math.round((client.transferTxHistory[index]/client.transferMax)*100) + '%',
                    background: client.hoverTx
                      ? '#992922'
                      : '#F3F4F6',
                    transition: 'all 0.2s',
                    borderRadius: '2px 2px 0 0',
                  }"></div>

                                    <!-- RX -->
                                    <div :style="{
                    minHeight: '0px',
                    minWidth: '2px',
                    maxWidth: '4px',
                    width: '50%',
                    height: Math.round((client.transferRxHistory[index]/client.transferMax)*100) + '%',
                    background: client.hoverRx
                    ? '#992922'
                    : '#F0F1F3',
                    transition: 'all 0.2s',
                    borderRadius: '2px 2px 0 0',
                  }"></div>
                                </div>
                            </div>

                            <div class="relative p-5 z-10 flex flex-row">
                                <div class="flex-grow">
                                    <!-- Name -->
                                    <div class="text-gray-700 group" :title="'Created on ' + dateTime(new Date(client.createdAt))">
                                        <!-- Show -->
                                        <input v-show="clientEditNameId === client.id" v-model="clientEditName" v-on:keyup.enter="updateClientName(client, clientEditName); clientEditName = null; clientEditNameId = null;" v-on:keyup.escape="clientEditName = null; clientEditNameId = null;" :ref="'client-' + client.id + '-name'" class="rounded px-1 border-2 border-gray-100 focus:border-gray-200 outline-none w-30" />
                                        <span v-show="clientEditNameId !== client.id" class="inline-block border-t-2 border-b-2 border-transparent text-white">{{client.name}}</span>

                                        <!-- Edit -->
                                        <span v-show="clientEditNameId !== client.id" @click="clientEditName = client.name; clientEditNameId = client.id; setTimeout(() => $refs['client-' + client.id + '-name'][0].select(), 1);" class="cursor-pointer opacity-0 group-hover:opacity-100 transition-opacity">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline align-middle opacity-25 hover:opacity-100" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                            </svg>
                                        </span>
                                    </div>

                                    <!-- Info -->
                                    <div class="text-gray-400 text-xs">
                                        <!-- Address -->
                                        <span class="group">
                                            <!-- Show -->
                                            <input v-show="clientEditAddressId === client.id" v-model="clientEditAddress" v-on:keyup.enter="updateClientAddress(client, clientEditAddress); clientEditAddress = null; clientEditAddressId = null;" v-on:keyup.escape="clientEditAddress = null; clientEditAddressId = null;" :ref="'client-' + client.id + '-address'" class="rounded border-2 border-gray-100 focus:border-gray-200 outline-none w-20 text-black" />
                                            <span v-show="clientEditAddressId !== client.id" class="inline-block border-t-2 border-b-2 border-transparent">{{client.address}}</span>

                                            <!-- Edit -->
                                            <span v-show="clientEditAddressId !== client.id" @click="clientEditAddress = client.address; clientEditAddressId = client.id; setTimeout(() => $refs['client-' + client.id + '-address'][0].select(), 1);" class="cursor-pointer opacity-0 group-hover:opacity-100 transition-opacity">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline align-middle opacity-25 hover:opacity-100" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                </svg>
                                            </span>
                                        </span>

                                        <!-- Transfer TX -->
                                        <span v-if="client.transferTx" :title="'Total Download: ' + bytes(client.transferTx)" @mouseover="client.hoverTx = clientsPersist[client.id].hoverTx = true;" @mouseleave="client.hoverTx = clientsPersist[client.id].hoverTx = false;" style="cursor: default; margin-right: 10px;">
                                            <i class="fa-solid fa-down-long"></i> <span>{{client.transferTxCurrent | bytes}}/s</span>
                                        </span>

                                        <!-- Transfer RX -->
                                        <span v-if="client.transferRx" :title="'Total Upload: ' + bytes(client.transferRx)" @mouseover="client.hoverRx = clientsPersist[client.id].hoverRx = true;" @mouseleave="client.hoverRx = clientsPersist[client.id].hoverRx = false;" style="cursor: default; margin-right: 10px;">
                                            <i class="fa-solid fa-up-long"></i> <span>{{client.transferRxCurrent | bytes}}/s</span>
                                        </span>

                                        <!-- Last seen -->
                                        <span v-if="client.latestHandshakeAt" :title="'Last seen on ' + dateTime(new Date(client.latestHandshakeAt))">
                                            {{new Date(client.latestHandshakeAt) | timeago}}
                                        </span>
                                    </div>
                                </div>

                                <div class="text-right">
                                    <div class="text-gray-400">
                                        <!-- Enable/Disable -->
                                        <div @click="disableClient(client)" v-if="client.enabled === true" title="Disable Client" class="inline-block align-middle rounded-full w-10 h-6 mr-1 bg-green-900 cursor-pointer hover:bg-green-700 transition-all">
                                            <div class="rounded-full w-4 h-4 m-1 ml-5 bg-white"></div>
                                        </div>
                                        <div @click="enableClient(client)" v-if="client.enabled === false" title="Enable Client" class="inline-block align-middle rounded-full w-10 h-6 mr-1 bg-red-900 cursor-pointer hover:bg-red-700 transition-all">
                                            <div class="rounded-full w-4 h-4 m-1 bg-white"></div>
                                        </div>

                                        <!-- Show QR-->
                                        <button style="width: 40px; height: 40px; outline: none;" class="align-middle text-center bg-black hover:bg-red-900 hover:text-white rounded transition" title="Show QR Code" @click="qrcode = `./api/wireguard/client/${client.id}/qrcode.svg`">
                                            <i class="fa-solid fa-qrcode"></i>
                                        </button>

                                        <!-- Download Config -->
                                        <a :href="'./api/wireguard/client/' + client.id + '/configuration'" download>
                                            <button style="width: 40px; height: 40px; outline: none;" class="align-middle text-center bg-black hover:bg-red-900 hover:text-white rounded transition" title="Download Configuration">
                                                <i class="fa-solid fa-cloud-arrow-down"></i>
                                            </button>
                                        </a>

                                        <!-- Delete -->
                                        <button style="width: 40px; height: 40px; outline: none;" class="align-middle text-center bg-black hover:bg-red-900 hover:text-white rounded transition" title="Delete Client" @click="clientDelete = client">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div v-if="clients && clients.length === 0">
                            <p class="text-center m-10 text-gray-400 text-sm">There are no clients yet.<br /><br />
                                <button @click="clientCreate = true; clientCreateName = '';" class="bg-red-900 text-white hover:bg-red-700 border-2 border-none py-2 px-4 rounded inline-flex items-center transition">
                                    <svg class="w-4 mr-2" inline xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                    </svg>

                                    <span class="text-sm">New Client</span>
                                </button>
                            </p>
                        </div>

                        <div v-if="clients === null" class="text-gray-200 p-5">
                            <svg class="w-5 animate-spin mx-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- QR Code-->
                <div v-if="qrcode">
                    <div class="bg-black bg-opacity-50 fixed top-0 right-0 left-0 bottom-0 flex items-center justify-center z-20">
                        <div class="bg-white rounded-md shadow-lg relative p-8">
                            <button @click="qrcode = null" class="absolute right-4 top-4 text-gray-600 hover:text-gray-800">
                                <svg class="w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                            <img :src="qrcode" />
                        </div>
                    </div>
                </div>

                <!-- Create Dialog -->
                <div v-if="clientCreate" class="fixed z-10 inset-0 overflow-y-auto">
                    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                            <div class="absolute inset-0 bg-black opacity-75"></div>
                        </div>

                        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

                        <div style="background: #151515;" class="inline-block align-bottom rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full" role="dialog" aria-modal="true" aria-labelledby="modal-headline">
                            <div style="background: #151515;" class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <div class="sm:flex sm:items-start">
                                    <div class="flex-grow mt-3 text-center sm:mt-0 sm:text-left">
                                        <h3 class="text-lg leading-6 font-medium text-white" id="modal-headline">
                                            New Client
                                        </h3>

                                        <div class="mt-2">
                                            <p class="text-sm text-gray-500">
                                                <input class="rounded p-2 border-2 border-red-900 focus:border-red-700 outline-none w-full bg-black" type="text" v-model.trim="clientCreateName" placeholder="Name" />
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style="background: #151515;" class="px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button v-if="clientCreateName.length" type="button" @click="createClient(); clientCreate = null" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-900 text-base font-medium text-white hover:bg-green-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                                    Create
                                </button>
                                <button v-else type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-900 text-base font-medium text-white sm:ml-3 sm:w-auto sm:text-sm cursor-not-allowed opacity-75">
                                    Create
                                </button>
                                <button type="button" @click="clientCreate = null" class="mt-3 w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-900 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete Dialog -->
                <div v-if="clientDelete" class="fixed z-10 inset-0 overflow-y-auto">
                    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">

                        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                            <div class="absolute inset-0 bg-black opacity-75"></div>
                        </div>

                        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

                        <div class="inline-block align-bottom bg-red-900 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full" role="dialog" aria-modal="true" aria-labelledby="modal-headline">
                            <div class="bg-red-900 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <div class="sm:flex sm:items-start">
                                    <div class="mt-3 text-center sm:mt-0 sm:text-left">
                                        <h3 class="text-lg leading-6 font-medium text-white" id="modal-headline">
                                            Delete Client
                                        </h3>

                                        <div class="mt-2">
                                            <p class="text-sm text-gray-100">
                                                Are you sure you want to delete <strong>{{clientDelete.name}}</strong>?
                                                This action cannot be undone.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-red-900 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="button" @click="deleteClient(clientDelete); clientDelete = null" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                                    Delete
                                </button>
                                <button type="button" @click="clientDelete = null" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="authenticated === false">
                <h1 class="text-4xl font-medium mt-16 mb-2 text-gray-300 text-center">SentinelGuard</h1>
                <p v-cloak class="text-center text-gray-500 text-xs"><a class="hover:underline" href="https://github.com/carlowisse/sentinel-guard" target="_blank">GitHub</a></p>

                <form @submit="login" class="shadow rounded-md mx-auto w-64 p-5 overflow-hidden mt-10" style="background: #111111;">
                    <div class="h-20 w-20 mb-10 mt-5 mx-auto rounded-full bg-red-900 relative overflow-hidden">
                        <!-- <svg class="w-10 h-10 m-5 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                        </svg> -->
                    </div>

                    <input type="password" name="password" placeholder="Password" v-model="password" class="px-3 py-2 text-sm text-gray-300 mb-5 border-2 border-red-900 rounded-lg w-full focus:border-red-500 outline-none" style="background: #333333;" />

                    <button v-if="authenticating" class="bg-red-900 w-full rounded shadow py-2 text-sm text-white cursor-not-allowed">
                        <svg class="w-5 animate-spin mx-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                    </button>

                    <input v-if="!authenticating && password" type="submit" class="bg-red-900 w-full rounded shadow py-2 text-sm text-white hover:bg-red-700 transition cursor-pointer" value="Sign In">

                    <input v-if="!authenticating && !password" type="submit" style="background: #333333;" class=" w-full rounded shadow py-2 text-sm text-white cursor-not-allowed" value="Sign In">
                </form>
            </div>

            <div v-if="authenticated === null" class="text-gray-300 pt-24 pb-12">
                <svg class="w-5 animate-spin mx-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
            </div>
        </div>
    </div>

    <script src="./libraries/js/vue.min.js"></script>
    <script src="./libraries/js/md5.min.js"></script>
    <script src="./libraries/js/timeago.min.js"></script>
    <script src="./js/api.js"></script>
    <script src="./js/app.js"></script>
</body>

</html>
